<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üéÖ</text>   </svg>">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santa's Command Center - Auto Processing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .snowflake { position: fixed; top: -10px; z-index: 9999; user-select: none; pointer-events: none; animation-name: snow; animation-timing-function: linear; animation-iteration-count: infinite; color: white; }
        @keyframes snow { 0% { transform: translateY(0); } 100% { transform: translateY(100vh); } }
    </style>
</head>
<body class="bg-gradient-to-b from-red-50 to-green-50 min-h-screen">
    <div id="app" class="p-8 max-w-7xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-red-600 mb-2">‚ú® Santa's Command Center ‚ú®</h1>
            <p class="text-gray-600 text-lg">Instant Letter Processing System - No Stamps Required! üéÖ</p>
        </div>

        <div class="flex justify-center gap-4 mb-6">
            <button onclick="switchView('processor')" id="btn-processor" class="px-6 py-3 rounded-lg font-bold bg-red-600 text-white shadow-lg transition-all transform hover:scale-105">
                üìß Letter Processor
            </button>
            <button onclick="switchView('map')" id="btn-map" class="px-6 py-3 rounded-lg font-bold bg-white text-gray-700 hover:bg-gray-100 transition-all transform hover:scale-105">
                üó∫Ô∏è Delivery Map
            </button>
        </div>

        <div id="processor-view">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-xl p-6 border-t-4 border-green-500">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">üì• North Pole Mailbox</h2>
                        <button onclick="loadEmails()" id="load-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2">
                            <span>üîÑ Check Mail</span>
                        </button>
                    </div>
                    <div id="email-list" class="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                        <div class="text-center py-12 text-gray-400 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                            <p class="text-4xl mb-3">üì≠</p>
                            <p>Mailbox is empty.</p>
                            <p class="text-sm">Click "Check Mail" to sync with satellites.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-xl p-6 border-t-4 border-red-500">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üéÅ Magic Decoder</h2>
                    <div id="drop-zone" class="border-4 border-dashed border-gray-300 rounded-lg p-6 mb-4 hover:border-red-400 hover:bg-red-50 transition-colors relative">
                        <div class="text-center text-gray-600 mb-4 pointer-events-none">
                            <p class="text-3xl mb-2">‚ú®</p>
                            <p class="font-semibold">Drag & Drop letters here</p>
                            <p class="text-sm opacity-75">or paste text manually</p>
                        </div>
                        <textarea 
                            id="letter-input" 
                            placeholder="Example: Dear Santa, I am Tom from Berlin. I want a robot and a ball."
                            class="w-full h-32 p-4 border-2 border-gray-200 rounded-lg focus:border-red-500 focus:outline-none resize-none bg-transparent relative z-10"
                        ></textarea>
                    </div>
                    
                    <button onclick="processLetterLocal()" id="process-btn" class="w-full bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white font-bold py-4 px-6 rounded-lg shadow-md transition-all transform hover:-translate-y-1 flex justify-center items-center gap-2">
                        <span>‚öôÔ∏è Activate Decoder</span>
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-xl p-6 mb-6 border-t-4 border-yellow-400">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üßù Elf Team Status</h2>
                <div id="elf-status" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
            </div>

            <div id="results-section" class="hidden bg-white rounded-lg shadow-xl p-6 border-t-4 border-blue-500">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">üìã The Nice List (<span id="child-count">0</span>)</h2>
                    <button onclick="clearAll()" class="text-gray-500 hover:text-red-500 font-semibold py-2 px-4 rounded flex items-center gap-1">
                        <span>üóëÔ∏è Clear List</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-blue-50 text-blue-800">
                                <th class="p-4 text-left font-bold rounded-l-lg">Name</th>
                                <th class="p-4 text-left font-bold">Location</th>
                                <th class="p-4 text-left font-bold">Wishes</th>
                                <th class="p-4 text-left font-bold">Handler</th>
                                <th class="p-4 text-left font-bold rounded-r-lg">Status</th>
                            </tr>
                        </thead>
                        <tbody id="results-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="map-view" class="hidden bg-white rounded-lg shadow-xl p-6 border-t-4 border-purple-500">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üó∫Ô∏è Global Sleigh Tracker</h2>
            <div class="relative rounded-lg overflow-hidden shadow-inner bg-blue-50">
                <svg id="delivery-map" class="w-full bg-gradient-to-br from-[#1a365d] to-[#2b6cb0]" viewBox="-180 -90 360 180" style="height: 600px;">
                    <defs>
                        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="white" stroke-opacity="0.1" stroke-width="0.5"/>
                        </pattern>
                    </defs>
                    <rect x="-180" y="-90" width="360" height="180" fill="url(#grid)" />
                </svg>
            </div>
            <div class="mt-6 flex flex-wrap gap-6 justify-center text-sm font-medium">
                <div class="flex items-center gap-2 bg-green-100 px-3 py-1 rounded-full text-green-800">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span>Ready at Base</span>
                </div>
                <div class="flex items-center gap-2 bg-blue-100 px-3 py-1 rounded-full text-blue-800">
                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    <span>Flying</span>
                </div>
                <div class="flex items-center gap-2 bg-purple-100 px-3 py-1 rounded-full text-purple-800">
                    <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                    <span>Gift Delivered</span>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 transform translate-y-20 transition-transform duration-300 z-50">
        <div id="toast-body" class="bg-white border-l-4 border-green-500 shadow-2xl rounded p-4 flex items-center gap-3">
            <div id="toast-icon" class="text-2xl">‚úÖ</div>
            <div>
                <h4 id="toast-title" class="font-bold text-gray-800">Success</h4>
                <p id="toast-msg" class="text-sm text-gray-600">Operation completed.</p>
            </div>
        </div>
    </div>

    <script>
        // State
        let children = [];
        let elves = [
            {id: 1, name: 'Jingles', status: 'available', lat: 90, lng: 0, targetLat: null, targetLng: null, child: null},
            {id: 2, name: 'Sparkle', status: 'available', lat: 90, lng: 0, targetLat: null, targetLng: null, child: null},
            {id: 3, name: 'Buddy', status: 'available', lat: 90, lng: 0, targetLat: null, targetLng: null, child: null},
            {id: 4, name: 'Twinkle', status: 'available', lat: 90, lng: 0, targetLat: null, targetLng: null, child: null},
            {id: 5, name: 'Blitz', status: 'available', lat: 90, lng: 0, targetLat: null, targetLng: null, child: null}
        ];
        
        // Extended location database for better hit rate
        const locationDB = {
            'new york': {lat: 40.7, lng: -74, label: "New York, USA"},
            'chicago': {lat: 41.8, lng: -87.6, label: "Chicago, USA"},
            'london': {lat: 51.5, lng: -0.1, label: "London, UK"},
            'tokyo': {lat: 35.6, lng: 139.6, label: "Tokyo, Japan"},
            'paris': {lat: 48.8, lng: 2.3, label: "Paris, France"},
            'sydney': {lat: -33.8, lng: 151.2, label: "Sydney, Australia"},
            'toronto': {lat: 43.6, lng: -79.3, label: "Toronto, Canada"},
            'berlin': {lat: 52.5, lng: 13.4, label: "Berlin, Germany"},
            'mumbai': {lat: 19.0, lng: 72.8, label: "Mumbai, India"},
            'rio': {lat: -22.9, lng: -43.1, label: "Rio, Brazil"},
            'pole': {lat: 90, lng: 0, label: "North Pole"}
        };

        const emails = [
            {id: '1', from: 'emily@gmail.com', subject: 'Letter to Santa from Emily',
             snippet: 'Dear Santa, My name is Emily and I live in New York...',
             body: 'Dear Santa,\n\nMy name is Emily and I live in New York. I have been very good this year! For Christmas, I would love a new bicycle, some art supplies, and a puppy.\n\nThank you!\nEmily'},
            {id: '2', from: 'timmy@yahoo.com', subject: 'Christmas Wishes from Timmy',
             snippet: 'Dear Santa, My name is Timmy and I live in Chicago...',
             body: 'Dear Santa,\n\nMy name is Timmy and I live in Chicago. This year I would really love a LEGO set, a new soccer ball, and some books about dinosaurs.\n\nThank you!\nTimmy'},
            {id: '3', from: 'sophia@outlook.com', subject: 'From Sophia - Christmas List',
             snippet: 'Hi Santa! I\'m Sophia from London...',
             body: 'Hi Santa!\n\nI\'m Sophia from London, England. I would love a telescope to look at stars, a science kit, and a new teddy bear.\n\nLove,\nSophia'}
        ];

        let currentView = 'processor';

        function switchView(view) {
            currentView = view;
            document.getElementById('processor-view').classList.toggle('hidden', view !== 'processor');
            document.getElementById('map-view').classList.toggle('hidden', view !== 'map');
            document.getElementById('btn-processor').className = view === 'processor' 
                ? 'px-6 py-3 rounded-lg font-bold bg-red-600 text-white shadow-lg transition-all transform hover:scale-105'
                : 'px-6 py-3 rounded-lg font-bold bg-white text-gray-700 hover:bg-gray-100 transition-all transform hover:scale-105';
            document.getElementById('btn-map').className = view === 'map' 
                ? 'px-6 py-3 rounded-lg font-bold bg-red-600 text-white shadow-lg transition-all transform hover:scale-105'
                : 'px-6 py-3 rounded-lg font-bold bg-white text-gray-700 hover:bg-gray-100 transition-all transform hover:scale-105';
            if (view === 'map') updateMap();
        }

        function loadEmails() {
            const list = document.getElementById('email-list');
            list.innerHTML = emails.map(e => `
                <div draggable="true" ondragstart="dragStart(event, '${e.id}')" 
                     class="border border-gray-200 rounded-lg p-4 cursor-grab active:cursor-grabbing hover:border-red-400 hover:bg-red-50 hover:shadow-md transition-all bg-white group">
                    <div class="flex justify-between items-start">
                        <div class="font-bold text-gray-800 group-hover:text-red-600">${e.subject}</div>
                        <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded">New</span>
                    </div>
                    <div class="text-xs text-gray-500 mb-2">${e.from}</div>
                    <div class="text-sm text-gray-600 line-clamp-2 italic border-l-2 border-gray-300 pl-2">${e.snippet}</div>
                </div>
            `).join('');
            showToast('Mail Retrieved', '3 letters found in the mailbox.', 'success');
        }

        function dragStart(e, id) {
            e.dataTransfer.setData('emailId', id);
            e.dataTransfer.effectAllowed = 'copy';
        }

        document.getElementById('drop-zone').addEventListener('dragover', e => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        document.getElementById('drop-zone').addEventListener('drop', e => {
            e.preventDefault();
            const id = e.dataTransfer.getData('emailId');
            const email = emails.find(em => em.id === id);
            if (email) {
                document.getElementById('letter-input').value = email.body;
                processLetterLocal();
            }
        });

        // --- THE "LOCAL INTELLIGENCE" ENGINE ---
        // This replaces the API call with smart regex parsing
        async function processLetterLocal() {
            const text = document.getElementById('letter-input').value.trim();
            if (!text) {
                showToast('Empty Letter', 'Please paste a letter first!', 'error');
                return;
            }

            const btn = document.getElementById('process-btn');
            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin text-xl">‚ùÑÔ∏è</span><span>Decoding Magic...</span>';

            // Simulate "AI Thinking" delay
            await new Promise(r => setTimeout(r, 1200));

            try {
                // 1. Extract Name
                // Looks for: "Name is X", "I am X", "I'm X", "Love, X", "From X"
                let name = "A Secret Friend";
                const nameRegex = /(?:name is|I'm|I am|Love,|From) ([A-Z][a-z]+)/i;
                const nameMatch = text.match(nameRegex);
                if (nameMatch) name = nameMatch[1];

                // 2. Extract Location
                // Looks for cities in our DB or "live in X", "from X"
                let location = "Unknown Location";
                let coords = {lat: 0, lng: 0};
                
                // First check strictly against our DB for coordinates
                const lowerText = text.toLowerCase();
                let foundCityKey = null;
                
                for (const city in locationDB) {
                    if (lowerText.includes(city)) {
                        foundCityKey = city;
                        break;
                    }
                }

                if (foundCityKey) {
                    location = locationDB[foundCityKey].label;
                } else {
                    // Try to guess via regex if not in DB
                    const locRegex = /(?:live in|from) ([A-Z][a-z]+(?: [A-Z][a-z]+)*)/i;
                    const locMatch = text.match(locRegex);
                    if (locMatch) location = locMatch[1];
                }

                // 3. Extract Gifts
                // Looks for sentences with "want", "wish", "love", "like" and splits by commas/and
                let gifts = ["A surprise gift"];
                // Find the sentence containing desire keywords
                const desireSentences = text.match(/[^.!?]*\b(want|wish|love|like|please)\b[^.!?]*[.!?]/gi);
                
                if (desireSentences) {
                    // Take the first matching sentence
                    let giftString = desireSentences[0];
                    // Remove the starter words (e.g. "I would love a...")
                    giftString = giftString.replace(/.*(want|wish|love|like|please)( a)?/i, '');
                    // Split by comma or 'and'
                    const rawGifts = giftString.split(/,| and /).map(g => g.replace(/[^a-z0-9 ]/gi, '').trim()).filter(g => g.length > 2);
                    if (rawGifts.length > 0) gifts = rawGifts;
                }

                // Create the child object
                const newKid = {
                    name: name,
                    location: location,
                    gifts: gifts,
                    status: 'pending',
                    elf: null
                };

                children.push(newKid);
                assignElf(newKid);
                
                document.getElementById('letter-input').value = '';
                renderResults();
                showToast('Magic Successful!', `Processed letter from ${name}`, 'success');

            } catch (err) {
                console.error(err);
                showToast('Oops!', 'The magic sputtered. Try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        }

        function assignElf(kid) {
            const elf = elves.find(e => e.status === 'available');
            
            // If no elves, queue it (simple logic for now just alerts)
            if (!elf) {
                showToast('High Traffic!', 'All elves are busy flying!', 'warning');
                return;
            }

            // Find coordinates
            let targetCoords = locationDB['pole']; // Default
            const kidLocLower = kid.location.toLowerCase();
            
            // Check matches
            for (const [key, data] of Object.entries(locationDB)) {
                if (kidLocLower.includes(key)) {
                    targetCoords = data;
                    break;
                }
            }

            // Randomize slightly if unknown location so they don't all go to 0,0
            if (targetCoords.label === "North Pole" && !kidLocLower.includes("pole")) {
                targetCoords = {
                    lat: 30 + (Math.random() * 20), 
                    lng: -100 + (Math.random() * 100)
                };
            }

            elf.status = 'delivering';
            elf.targetLat = targetCoords.lat;
            elf.targetLng = targetCoords.lng;
            elf.child = kid.name;
            kid.elf = elf.name;
            kid.status = 'in-progress';
            renderElves();
        }

        function renderElves() {
            document.getElementById('elf-status').innerHTML = elves.map(e => `
                <div class="bg-white border-2 ${e.status === 'available' ? 'border-green-200' : e.status === 'delivering' ? 'border-blue-200' : 'border-purple-200'} rounded-lg p-3 text-center shadow-sm relative overflow-hidden">
                    <div class="text-3xl mb-1 transition-transform hover:scale-110 cursor-default">üßù</div>
                    <div class="font-bold text-gray-800">${e.name}</div>
                    <div class="text-xs font-bold mt-1 uppercase tracking-wider ${
                        e.status === 'available' ? 'text-green-600' : 
                        e.status === 'delivering' ? 'text-blue-600' : 'text-purple-600'
                    }">
                        ${e.status}
                    </div>
                    ${e.child ? `<div class="text-xs text-gray-500 mt-1 truncate">Mission: ${e.child}</div>` : ''}
                    
                    ${e.status === 'delivered' ? `
                        <button onclick="returnElf(${e.id})" class="mt-2 text-xs bg-green-500 hover:bg-green-600 text-white w-full py-1 rounded transition-colors">
                            Return Base
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        function returnElf(id) {
            const elf = elves.find(e => e.id === id);
            elf.status = 'available';
            elf.lat = 90;
            elf.lng = 0;
            elf.targetLat = null;
            elf.targetLng = null;
            elf.child = null;
            renderElves();
        }

        function renderResults() {
            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('child-count').textContent = children.length;
            document.getElementById('results-body').innerHTML = children.map((c, i) => `
                <tr class="border-b hover:bg-blue-50 transition-colors">
                    <td class="p-4 font-semibold text-gray-800">${c.name}</td>
                    <td class="p-4 text-gray-600">${c.location}</td>
                    <td class="p-4">
                        <div class="flex flex-wrap gap-1">
                            ${c.gifts.map(g => `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full border border-yellow-200">${g}</span>`).join('')}
                        </div>
                    </td>
                    <td class="p-4">
                        ${c.elf 
                            ? `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-sm font-medium border border-gray-200">üßù ${c.elf}</span>` 
                            : '<span class="text-gray-400 text-sm">Queued...</span>'}
                    </td>
                    <td class="p-4">
                        <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${
                            c.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                            c.status === 'in-progress' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'
                        }">
                            ${c.status}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function clearAll() {
            children = [];
            elves.forEach(e => {
                e.status = 'available';
                e.lat = 90;
                e.lng = 0;
                e.targetLat = null;
                e.targetLng = null;
                e.child = null;
            });
            document.getElementById('results-section').classList.add('hidden');
            renderElves();
            showToast('Reset Complete', 'System ready for next batch.', 'success');
        }

        // Fancy Toast Notification System
        function showToast(title, msg, type) {
            const toast = document.getElementById('toast');
            const body = document.getElementById('toast-body');
            const icon = document.getElementById('toast-icon');
            const titleEl = document.getElementById('toast-title');
            const msgEl = document.getElementById('toast-msg');

            titleEl.textContent = title;
            msgEl.textContent = msg;
            
            if (type === 'success') {
                body.className = 'bg-white border-l-4 border-green-500 shadow-2xl rounded p-4 flex items-center gap-3';
                icon.textContent = '‚úÖ';
            } else if (type === 'error') {
                body.className = 'bg-white border-l-4 border-red-500 shadow-2xl rounded p-4 flex items-center gap-3';
                icon.textContent = '‚ùå';
            } else {
                body.className = 'bg-white border-l-4 border-yellow-500 shadow-2xl rounded p-4 flex items-center gap-3';
                icon.textContent = '‚ö†Ô∏è';
            }

            toast.classList.remove('translate-y-20');
            setTimeout(() => toast.classList.add('translate-y-20'), 3000);
        }

        // Animation Loop
        function updateMap() {
            const svg = document.getElementById('delivery-map');
            
            // Draw North Pole
            let html = '<circle cx="0" cy="-85" r="4" fill="#ef4444" stroke="white" stroke-width="1"/><text x="0" y="-78" text-anchor="middle" fill="white" font-size="4" font-weight="bold">‚òÖ North Pole</text>';
            
            elves.forEach(e => {
                const x = e.lng * 2;
                const y = -e.lat; // Invert lat for SVG coordinate system
                
                // Color coding
                const color = e.status === 'available' ? '#10B981' : e.status === 'delivering' ? '#3B82F6' : '#9333EA';
                
                // Draw Path if moving
                if (e.targetLat && e.targetLng) {
                    html += `<line x1="${x}" y1="${y}" x2="${e.targetLng * 2}" y2="${-e.targetLat}" stroke="${color}" stroke-width="0.5" stroke-dasharray="2,2" opacity="0.5"/>`;
                    html += `<circle cx="${e.targetLng * 2}" cy="${-e.targetLat}" r="2" fill="${color}" opacity="0.3"/>`;
                }

                // Draw Elf
                html += `<g transform="translate(${x},${y})">`;
                html += `<circle r="3" fill="${color}" stroke="white" stroke-width="0.5"/>`;
                html += `<text y="-5" text-anchor="middle" font-size="3" fill="white" font-weight="bold" style="text-shadow: 0px 1px 2px rgba(0,0,0,0.5);">${e.name}</text>`;
                html += `</g>`;
            });
            
            svg.innerHTML += html;
        }

        // Game Loop (Movement Logic)
        setInterval(() => {
            let needsUpdate = false;
            elves.forEach(e => {
                if (e.status === 'delivering' && e.targetLat !== null) {
                    needsUpdate = true;
                    const dx = e.targetLat - e.lat;
                    const dy = e.targetLng - e.lng;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < 2) {
                        e.status = 'delivered';
                        e.lat = e.targetLat;
                        e.lng = e.targetLng;
                        
                        // Update child status
                        const child = children.find(c => c.name === e.child);
                        if (child) {
                            child.status = 'delivered';
                            renderResults(); // Refresh table status
                        }
                    } else {
                        // Move elf (speed factor)
                        e.lat += dx * 0.08;
                        e.lng += dy * 0.08;
                    }
                } else if (e.status === 'available') {
                    // Idle animation (bobbing)
                    e.lat = 90 + Math.sin(Date.now() / 500) * 1; 
                    e.lng = 0 + Math.cos(Date.now() / 500) * 2; 
                    needsUpdate = true;
                }
            });
            
            renderElves();
            if (currentView === 'map' && needsUpdate) {
                const svg = document.getElementById('delivery-map');
                // clear dynamic elements but keep background (hacky way for vanilla JS)
                const staticContent = `<defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="white" stroke-opacity="0.1" stroke-width="0.5"/></pattern></defs><rect x="-180" y="-90" width="360" height="180" fill="url(#grid)" />`;
                svg.innerHTML = staticContent; 
                updateMap();
            }
        }, 50);

        // Snow effect setup
        function createSnow() {
            const snow = document.createElement('div');
            snow.innerHTML = '‚ùÑ';
            snow.className = 'snowflake';
            snow.style.left = Math.random() * 100 + 'vw';
            snow.style.opacity = Math.random();
            snow.style.fontSize = (Math.random() * 10 + 10) + 'px';
            const duration = Math.random() * 5 + 5;
            snow.style.animationDuration = duration + 's';
            document.body.appendChild(snow);
            setTimeout(() => snow.remove(), duration * 1000);
        }
        setInterval(createSnow, 300);

        renderElves();
    </script>
</body>
</html>
